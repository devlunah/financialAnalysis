Option Explicit

Public dictSomasCartao As New Dictionary
Public dictExtrato As New Dictionary

Sub cartaoExt()

    Dim wsCartao As Worksheet
    Set wsCartao = ThisWorkbook.Worksheets("CIELORECEB")

    Dim ultimaLinhaCartao As Long
    ultimaLinhaCartao = wsCartao.Cells(wsCartao.Rows.Count, "A").End(xlUp).Row
    
    Dim dictCartao As New Dictionary
    Dim chave As String
    
    Dim i As Long
    Dim Data As Date
    Dim receb As clsCustomer
    
    Dim valorCredV As Double, valorCredM As Double, valorCredE As Double, valorCredAE As Double
    Dim valorDebV As Double, valorDebM As Double, valorDebE As Double, valorDebAE As Double
    Dim valorOutras As Double
    
    For i = 3 To ultimaLinhaCartao
    
        wsCartao.Cells(i, 6).Value = Format(wsCartao.Cells(i, 6).Value, "#,##0.00")
        wsCartao.Cells(i, 2).Value = UCase(wsCartao.Cells(i, 2).Value)
        wsCartao.Cells(i, 3).Value = UCase(wsCartao.Cells(i, 3).Value)
        
        Data = wsCartao.Cells(i, 1).Value
        If dictCartao.Exists(Data) = False Then
            Set receb = New clsCustomer
            receb.dataPgto = Data
            dictCartao.Add receb.dataPgto, receb
        Else
            Set receb = dictCartao(Data)
            
        End If
        
        With receb
        
            .formaPgto = wsCartao.Cells(i, 2).Value
            .bandeira = wsCartao.Cells(i, 3).Value
            .ValorLiq = wsCartao.Cells(i, 6).Value
            .maquininha = wsCartao.Cells(i, 7).Value
            
            
            Debug.Print .dataPgto, .formaPgto, .bandeira, .ValorLiq, .maquininha
            
            If Not dictSomasCartao.Exists(.dataPgto) Then
                dictSomasCartao.Add .dataPgto, New Dictionary
            End If

            If Not dictSomasCartao(.dataPgto).Exists(.formaPgto) Then
                dictSomasCartao(.dataPgto).Add .formaPgto, New Dictionary
            End If

            If Not dictSomasCartao(.dataPgto)(.formaPgto).Exists(.bandeira) Then
                dictSomasCartao(.dataPgto)(.formaPgto).Add .bandeira, New Dictionary
            End If

            If Not dictSomasCartao(.dataPgto)(.formaPgto)(.bandeira).Exists(.maquininha) Then
                dictSomasCartao(.dataPgto)(.formaPgto)(.bandeira).Add .maquininha, 0
            End If
            
            dictSomasCartao(.dataPgto)(.formaPgto)(.bandeira)(.maquininha) = dictSomasCartao(.dataPgto)(.formaPgto)(.bandeira)(.maquininha) + .ValorLiq
            
        End With

    Next
    
    Dim dataKey As Variant, formaKey As Variant, bandeiraKey As Variant, maqKey As Variant
    For Each dataKey In dictSomasCartao.Keys
        For Each formaKey In dictSomasCartao(dataKey).Keys
            For Each bandeiraKey In dictSomasCartao(dataKey)(formaKey).Keys
                For Each maqKey In dictSomasCartao(dataKey)(formaKey)(bandeiraKey).Keys
                    Debug.Print "Data: " & dataKey & ", Forma: " & formaKey & ", Bandeira: " & bandeiraKey & ", Maquininha: " & maqKey & ", Total: " & dictSomasCartao(dataKey)(formaKey)(bandeiraKey)(maqKey)
                Next maqKey
            Next bandeiraKey
        Next formaKey
    Next dataKey


Dim wsExt As Worksheet
Set wsExt = ThisWorkbook.Worksheets("ExtratosBancarios")

Dim ultimaLinhaExt As Long
ultimaLinhaExt = wsExt.Cells(wsExt.Rows.Count, "A").End(xlUp).Row


Dim j As Long
Dim textoCompleto As String
Dim partes() As String
Dim banco As String
Dim infoHistorico As clsExt


For j = 10 To ultimaLinhaExt
    
        banco = wsExt.Cells(j, 1).Value
        
        textoCompleto = wsExt.Cells(j, 6).Value
        
        partes = Split(textoCompleto, " ")
        
        Select Case banco
        
        Case "SICOOB - SIPAG"
        
            Set infoHistorico = New clsExt
            
            infoHistorico.detalhe = partes(0) & " " & partes(3)
            infoHistorico.FormaPgto_hist = UCase(partes(1))
            infoHistorico.bandeira = UCase(partes(2))
            
            If infoHistorico.FormaPgto_hist = "ANTECIPAÇÃO" Then
                infoHistorico.FormaPgto_hist = "CRÉDITO"
            End If
            
            If infoHistorico.FormaPgto_hist = "COMPRAS" Then
                If Trim(infoHistorico.detalhe) Like "*Cred._*" Then
                    infoHistorico.FormaPgto_hist = "CRÉDITO"
                Else
                    infoHistorico.FormaPgto_hist = "DÉBITO"
                End If
            End If
            
            If infoHistorico.bandeira = "MAESTRO" Then
                infoHistorico.bandeira = "MASTERCARD"
            End If
            
            If infoHistorico.bandeira = "DEB" Then
                infoHistorico.bandeira = "ELO"
            End If
            
            If infoHistorico.bandeira = "OUTRAS" Then
                infoHistorico.bandeira = "ELO"
            End If
            
            If infoHistorico.bandeira = "CRE" Then
                infoHistorico.bandeira = "ELO"
                infoHistorico.FormaPgto_hist = "CRÉDITO"
            End If
            
            If Not dictExtrato.Exists(j) Then
                dictExtrato.Add j, infoHistorico
            End If
            
            wsExt.Cells(j, 20).Value = "SICOOB"
            
        Case "SICOOB - CIELO"
        
            Set infoHistorico = New clsExt
            
            infoHistorico.detalhe = partes(0) & " " & partes(1)
            infoHistorico.FormaPgto_hist = UCase(partes(2))
            infoHistorico.bandeira = UCase(partes(3))
            
            If infoHistorico.FormaPgto_hist = "CRED." Then
                infoHistorico.FormaPgto_hist = "CRÉDITO"
            End If
    
            If Not dictExtrato.Exists(j) Then
                dictExtrato.Add j, infoHistorico
            End If
            
            wsExt.Cells(j, 20).Value = "SICOOB"
            
        Case "BB"
        
            Set infoHistorico = New clsExt
            
            infoHistorico.detalhe = partes(0) & " " & partes(1)
            infoHistorico.FormaPgto_hist = UCase(partes(2))
    
            If Not dictExtrato.Exists(j) Then
                dictExtrato.Add j, infoHistorico
            End If
            
            wsExt.Cells(j, 20).Value = wsExt.Cells(j, 1).Value
            
        Case "SANTANDER"
        
            Set infoHistorico = New clsExt
            
            infoHistorico.detalhe = partes(0) & " " & partes(1) & " " & partes(2)
            infoHistorico.FormaPgto_hist = UCase(partes(3))
            infoHistorico.bandeira = UCase(partes(4))
            
            If infoHistorico.bandeira Like "GETNET-ELO" Then
                infoHistorico.bandeira = "ELO"
            End If
            
            If Not dictExtrato.Exists(j) Then
                dictExtrato.Add j, infoHistorico
            End If
            
            wsExt.Cells(j, 20).Value = wsExt.Cells(j, 1).Value
        
        Case "STONE"
        
            Set infoHistorico = New clsExt
            
            infoHistorico.detalhe = partes(0) & " " & partes(1)
            infoHistorico.bandeira = UCase(partes(2))
            infoHistorico.FormaPgto_hist = UCase(partes(3))
            
            If Not dictExtrato.Exists(j) Then
                dictExtrato.Add j, infoHistorico
            End If
            
            wsExt.Cells(j, 20).Value = wsExt.Cells(j, 1).Value
        
        Case "INFINITEPAY"
        
            Set infoHistorico = New clsExt
            
            infoHistorico.detalhe = partes(0) & " " & partes(1) & " " & partes(3) & " " & partes(4)
            infoHistorico.bandeira = UCase(partes(2))
            infoHistorico.FormaPgto_hist = UCase(partes(5))
            
            If Not dictExtrato.Exists(j) Then
                dictExtrato.Add j, infoHistorico
            End If
            
            wsExt.Cells(j, 20).Value = wsExt.Cells(j, 1).Value
        
        End Select
        
    Next j

    Dim key As Variant
    For Each key In dictExtrato.Keys
        Debug.Print "Linha: " & key & ", Forma de Pagamento: " & dictExtrato(key).FormaPgto_hist & ", Bandeira: " & dictExtrato(key).bandeira, "Histórico: " & dictExtrato(key).detalhe
    Next key

    
    Dim historico As String
    Dim valorExtrato As Double
    Dim contador As Long
    Dim valorTotal As Double
    Dim dataPagamento As Date
    Dim bandeira As String
    Dim formaPgto As String
    Dim c As Long
    
    contador = 1
    
    For Each dataKey In dictSomasCartao.Keys
        For Each formaKey In dictSomasCartao(dataKey).Keys
            For Each bandeiraKey In dictSomasCartao(dataKey)(formaKey).Keys

                valorTotal = 0 ' Inicializa a variável
                For Each maqKey In dictSomasCartao(dataKey)(formaKey)(bandeiraKey).Keys
                    valorTotal = dictSomasCartao(dataKey)(formaKey)(bandeiraKey)(maqKey)

                    For Each key In dictExtrato.Keys
                        'Dim infoHistorico As clsExt
                        Set infoHistorico = dictExtrato(key)

                        dataPagamento = wsExt.Cells(key, 4).Value 

                        bandeira = infoHistorico.bandeira
                        
                        formaPgto = infoHistorico.FormaPgto_hist
                        
                        valorExtrato = wsExt.Cells(key, 7).Value 
    
                        If dataKey Like dataPagamento And formaKey Like formaPgto And bandeiraKey Like bandeira Then
                            If Abs(valorTotal - valorExtrato) < 0.01 Or (valorTotal - valorExtrato) > 0.01 Then
                            
                                If Not IsEmpty(wsExt.Cells(key, 9).Value) Then
                                    
                                Else
                                
                                    wsExt.Cells(key, 9).Value = "CONCILIADO COM CARTÃO"
                                    wsExt.Cells(key, 10).Value = "CONCILIAÇÃO CARTÃO" & " " & "-" & " " & contador
                                    
                                    For c = 3 To ultimaLinhaCartao
                                        If dataKey = wsCartao.Cells(c, 1).Value And _
                                           formaKey = wsCartao.Cells(c, 2).Value And _
                                           bandeiraKey = wsCartao.Cells(c, 3).Value Then
                                        
                                            wsCartao.Cells(c, 13).Value = "CONCILIADO COM EXTRATO"
                                            wsCartao.Cells(c, 14).Value = "CONCILIAÇÃO CARTÃO" & " " & "-" & " " & contador
                                        End If
                                    Next

                                End If
                                Debug.Print "Conciliação feita para: Data: " & dataKey & ", Forma: " & formaKey & ", Bandeira: " & bandeiraKey & ", Valor: " & valorTotal
                            End If
                        End If
                      
                    Next key
                    contador = contador + 1
                Next maqKey
            Next bandeiraKey
        Next formaKey
    Next dataKey
    
End Sub
Sub Receb_Boleto()

    Dim wsBoletos As Worksheet
    Dim wsExtrato As Worksheet
    Dim ultimaLinhaBoletos As Long
    Dim ultimaLinhaExtrato As Long
    Dim i As Long, j As Long, b As Long
    Dim dataPrevista As Variant
    Dim valorBoleto As Double, valorExt As Double
    Dim totalPorData As Double
    Dim dicDatas As Object
    Dim historico As String, banco As String, historicoLiquidacao As String, SICOOB As String, SICREDI As String
    Dim CONCILIADO As String
    Dim datasBol As Date
    Dim tolerancia As Double
    Dim contador As Long
    tolerancia = 0.04 

    Set dicDatas = CreateObject("Scripting.Dictionary")
    
    On Error Resume Next
    Set wsBoletos = ThisWorkbook.Sheets("BOLETODECOB")
    Set wsExtrato = ThisWorkbook.Sheets("ExtratosBancarios")
    On Error GoTo 0

    ultimaLinhaBoletos = wsBoletos.Cells(wsBoletos.Rows.Count, "A").End(xlUp).Row
    
    For i = 3 To ultimaLinhaBoletos ' Supondo que os dados comecem na linha 2
        dataPrevista = wsBoletos.Cells(i, "D").Value ' Coluna B contém a data prevista do boleto
        valorBoleto = wsBoletos.Cells(i, "L").Value ' Coluna C contém o valor do boleto

        If dicDatas.Exists(dataPrevista) Then
            dicDatas(dataPrevista) = dicDatas(dataPrevista) + valorBoleto
        Else
            dicDatas.Add dataPrevista, valorBoleto
        End If
    Next i

    ultimaLinhaExtrato = wsExtrato.Cells(wsExtrato.Rows.Count, "A").End(xlUp).Row
    
    contador = 1

    For Each dataPrevista In dicDatas.Keys
        totalPorData = dicDatas(dataPrevista)

        For j = 10 To ultimaLinhaExtrato 
            CONCILIADO = CStr(wsExtrato.Cells(j, "I").Value)
            If CONCILIADO = "CONCILIADO" Then

            Else
            banco = wsExtrato.Cells(j, "A").Value
            historico = wsExtrato.Cells(j, "F").Value 
            historicoLiquidacao = ""
            SICOOB = "CRÉD.LIQUIDAÇÃO COBRANÇA"
            SICREDI = "LIQ.COBRANCA SIMPLES"
            
            If banco = "SICOOB" Then
            historicoLiquidacao = SICOOB
            ElseIf banco = "SICREDI" Then
            historicoLiquidacao = SICREDI
            Else
             historicoLiquidacao = SICOOB
            End If

            If wsExtrato.Cells(j, "D").Value = dataPrevista And historico = historicoLiquidacao Then
                'identif = wsExtrato.Cells(j, "E").Value
                valorExt = CDbl(wsExtrato.Cells(j, "G").Value)
                If Abs(CDbl(valorExt) - CDbl(totalPorData)) <= tolerancia Then
                    wsExtrato.Cells(j, "I").Value = "CONCILIADO COM BOLETO"
                    wsExtrato.Cells(j, "J").Value = "CONCILIAÇÃO BOLETO" & " " & "-" & " " & contador
                    wsExtrato.Cells(j, 20).Value = wsExtrato.Cells(j, 1).Value
                    datasBol = wsExtrato.Cells(j, "D").Value
                    For b = 3 To ultimaLinhaBoletos
                      
                      If wsBoletos.Cells(b, "D") = datasBol Then
                         wsBoletos.Cells(b, "N").Value = "CONCILIAÇÃO BOLETO" & " " & "-" & " " & contador
                         wsBoletos.Cells(b, "Q").Value = totalPorData
                         wsBoletos.Cells(b, "R").Value = "CONCILIADO COM EXTRATO"
                      End If
                    Next b
                    
                    Exit For 
                End If
            End If
          End If
        Next j
        contador = contador + 1
    Next dataPrevista
    
    MsgBox "Processo de conciliação concluído!"


End Sub

Sub DestrincharExtratoComRecebimento()

    Dim wsExt As Worksheet
    Set wsExt = ThisWorkbook.Worksheets("ExtratosBancarios")

    Dim wsCartao As Worksheet
    Set wsCartao = ThisWorkbook.Worksheets("CIELORECEB")
    
    Dim wsBoleto As Worksheet
    Set wsBoleto = ThisWorkbook.Worksheets("BOLETODECOB")
    
    Dim ultimaLinhaExt As Long
    ultimaLinhaExt = wsExt.Cells(wsExt.Rows.Count, "A").End(xlUp).Row

    Dim ultimaLinhaCartao As Long
    ultimaLinhaCartao = wsCartao.Cells(wsCartao.Rows.Count, "A").End(xlUp).Row
    
    Dim ultimaLinhaBoleto As Long
    ultimaLinhaBoleto = wsBoleto.Cells(wsBoleto.Rows.Count, "A").End(xlUp).Row
    
    Dim i As Long, j As Long, b As Long
    Dim conciliacaoCartao As String, conciliacaoExt As String, conciliacaoBoleto As String, statusDestrinchamento As String
    Dim valorCartao As Double, valorBoleto As Double
    Dim x As Long
    Dim z As Long
    Dim cellsDestrinchada As Variant
    
    
    x = 1000
    
    For i = 10 To ultimaLinhaExt + x

        conciliacaoExt = wsExt.Cells(i, 10).Value
        statusDestrinchamento = wsExt.Cells(i, 12).Value

        If statusDestrinchamento = "Valor Destrinchado" Or statusDestrinchamento = "MONTANTE" Then
        
        Else
        
            For j = 3 To ultimaLinhaCartao
                conciliacaoCartao = wsCartao.Cells(j, 14).Value
                valorCartao = wsCartao.Cells(j, 6).Value
                
                If Not IsEmpty(wsCartao.Cells(j, 14).Value) Then
                
                    If conciliacaoExt = conciliacaoCartao Then
                        wsExt.Rows(i + 1).Insert Shift:=xlDown, CopyOrigin:=xlFormatFromLeftOrAbove
                            
                        wsExt.Cells(i + 1, 7).Value = valorCartao
                        wsExt.Cells(i + 1, 1).Value = wsExt.Cells(i, 1).Value
                        wsExt.Cells(i + 1, 4).Value = wsExt.Cells(i, 4).Value
                        wsExt.Cells(i + 1, 5).Value = wsExt.Cells(i, 5).Value
                        wsExt.Cells(i + 1, 6).Value = wsExt.Cells(i, 6).Value
                        wsExt.Cells(i + 1, 8).Value = wsExt.Cells(i, 8).Value
                        wsExt.Cells(i + 1, 9).Value = wsExt.Cells(i, 9).Value
                        wsExt.Cells(i + 1, 10).Value = wsExt.Cells(i, 10).Value
                        wsExt.Cells(i + 1, 12).Value = "Valor Destrinchado"
                        wsExt.Cells(i + 1, 18).Value = wsCartao.Cells(j, 5).Value
                        wsExt.Cells(i + 1, 20).Value = wsExt.Cells(i, 20).Value
                        
                        If Not IsEmpty(wsCartao.Cells(j, 15).Value) Then
                        
                            wsExt.Cells(i + 1, 11).Value = "NFS-e" & " " & wsCartao.Cells(j, 15).Value & " - " & wsCartao.Cells(j, 16).Value
                            wsExt.Cells(i + 1, 19).Value = "CONCILIADO_CARTÃO"
                        Else
                        
                            wsExt.Cells(i + 1, 11).Value = wsCartao.Cells(j, 15).Value & " - " & wsCartao.Cells(j, 16).Value
                            wsExt.Cells(i + 1, 19).Value = "A CONCILIAR_CARTÃO"
                            
                        End If
            
                        wsExt.Range(wsExt.Cells(i + 1, 1), wsExt.Cells(i + 1, 12)).Interior.Color = RGB(255, 255, 0)
                        
                        If wsExt.Cells(i, 12).Interior.Color <> RGB(255, 255, 0) Then
                            wsExt.Cells(i, 12).Value = "MONTANTE"
                        End If

                        
                        i = i + 1
                        
                    End If
                
                Else
                
                End If
                
                
            Next j
            
            For b = 3 To ultimaLinhaBoleto
                conciliacaoBoleto = wsBoleto.Cells(b, 14).Value
                valorBoleto = wsBoleto.Cells(b, 12).Value
                
                If Not IsEmpty(wsBoleto.Cells(b, 14).Value) Then
                
                    If conciliacaoBoleto = conciliacaoExt Then
                        wsExt.Rows(i + 1).Insert Shift:=xlDown, CopyOrigin:=xlFormatFromLeftOrAbove
                        
                        wsExt.Cells(i + 1, 7).Value = valorBoleto
                        wsExt.Cells(i + 1, 1).Value = wsExt.Cells(i, 1).Value
                        wsExt.Cells(i + 1, 4).Value = wsExt.Cells(i, 4).Value
                        wsExt.Cells(i + 1, 5).Value = wsExt.Cells(i, 5).Value
                        wsExt.Cells(i + 1, 6).Value = wsExt.Cells(i, 6).Value
                        wsExt.Cells(i + 1, 8).Value = wsExt.Cells(i, 8).Value
                        wsExt.Cells(i + 1, 9).Value = wsExt.Cells(i, 9).Value
                        wsExt.Cells(i + 1, 10).Value = wsExt.Cells(i, 10).Value
                        wsExt.Cells(i + 1, 12).Value = "Valor Destrinchado"
                        wsExt.Cells(i + 1, 17).Value = wsBoleto.Cells(b, 8).Value
                        wsExt.Cells(i + 1, 20).Value = wsExt.Cells(i, 1).Value
                        
                        If Not IsEmpty(wsBoleto.Cells(b, 15).Value) Then
                        
                            wsExt.Cells(i + 1, 11).Value = "NFS-e" & " " & wsBoleto.Cells(b, 15).Value & " - " & wsBoleto.Cells(b, 16).Value
                            wsExt.Cells(i + 1, 19).Value = "CONCILIADO_BOLETO"
                            
                        Else
                            wsExt.Cells(i + 1, 11).Value = wsBoleto.Cells(b, 15).Value & " - " & wsBoleto.Cells(b, 16).Value
                            wsExt.Cells(i + 1, 19).Value = "A CONCILIAR_BOLETO"
                        
                        End If
                        
        
                        wsExt.Range(wsExt.Cells(i + 1, 1), wsExt.Cells(i + 1, 12)).Interior.Color = RGB(255, 255, 0)
                        
                        If wsExt.Cells(i, 12).Interior.Color <> RGB(255, 255, 0) Then
                            wsExt.Cells(i, 12).Value = "MONTANTE"
                        Else
                        End If

                        i = i + 1
                        
                    End If
                
                Else
                
                End If
            
            Next b
        
        End If
        
    
    Next i
    

End Sub

Sub Export_Mister()

ExportacaoMister.Show

End Sub

Option Explicit

Public dictSomasCartao As New Dictionary
Public dictExtrato As New Dictionary

Sub Receb_Boleto()

    Dim wsBoletos As Worksheet
    Dim wsExtrato As Worksheet
    Dim ultimaLinhaBoletos As Long
    Dim ultimaLinhaExtrato As Long
    Dim i As Long, j As Long, b As Long
    Dim dataPrevista As Variant
    Dim valorBoleto As Double, valorExt As Double
    Dim totalPorData As Double
    Dim dicDatas As Object
    Dim historico As String, banco As String, historicoLiquidacao As String, SICOOB As String, SICREDI As String
    Dim CONCILIADO As String
    Dim datasBol As Date
    Dim tolerancia As Double
    Dim contador As Long
    tolerancia = 0.04 

    Set dicDatas = CreateObject("Scripting.Dictionary")
    
    On Error Resume Next
    Set wsBoletos = ThisWorkbook.Sheets("BOLETODECOB")
    Set wsExtrato = ThisWorkbook.Sheets("ExtratosBancarios")
    On Error GoTo 0

    ultimaLinhaBoletos = wsBoletos.Cells(wsBoletos.Rows.Count, "A").End(xlUp).Row
    
    For i = 3 To ultimaLinhaBoletos ' Supondo que os dados comecem na linha 2
        dataPrevista = wsBoletos.Cells(i, "D").Value ' Coluna B contém a data prevista do boleto
        valorBoleto = wsBoletos.Cells(i, "L").Value ' Coluna C contém o valor do boleto

        If dicDatas.Exists(dataPrevista) Then
            dicDatas(dataPrevista) = dicDatas(dataPrevista) + valorBoleto
        Else
            dicDatas.Add dataPrevista, valorBoleto
        End If
    Next i

    ultimaLinhaExtrato = wsExtrato.Cells(wsExtrato.Rows.Count, "A").End(xlUp).Row
    
    contador = 1

    For Each dataPrevista In dicDatas.Keys
        totalPorData = dicDatas(dataPrevista)

        For j = 10 To ultimaLinhaExtrato 
            CONCILIADO = CStr(wsExtrato.Cells(j, "I").Value)
            If CONCILIADO = "CONCILIADO" Then

            Else
            banco = wsExtrato.Cells(j, "A").Value
            historico = wsExtrato.Cells(j, "F").Value 
            historicoLiquidacao = ""
            SICOOB = "CRÉD.LIQUIDAÇÃO COBRANÇA"
            SICREDI = "LIQ.COBRANCA SIMPLES"
            
            If banco = "SICOOB" Then
            historicoLiquidacao = SICOOB
            ElseIf banco = "SICREDI" Then
            historicoLiquidacao = SICREDI
            Else
             historicoLiquidacao = SICOOB
            End If

            If wsExtrato.Cells(j, "D").Value = dataPrevista And historico = historicoLiquidacao Then
                'identif = wsExtrato.Cells(j, "E").Value
                valorExt = CDbl(wsExtrato.Cells(j, "G").Value)
                If Abs(CDbl(valorExt) - CDbl(totalPorData)) <= tolerancia Then
                    wsExtrato.Cells(j, "I").Value = "CONCILIADO COM BOLETO"
                    wsExtrato.Cells(j, "J").Value = "CONCILIAÇÃO BOLETO" & " " & "-" & " " & contador
                    wsExtrato.Cells(j, 20).Value = wsExtrato.Cells(j, 1).Value
                    datasBol = wsExtrato.Cells(j, "D").Value
                    For b = 3 To ultimaLinhaBoletos
                      
                      If wsBoletos.Cells(b, "D") = datasBol Then
                         wsBoletos.Cells(b, "N").Value = "CONCILIAÇÃO BOLETO" & " " & "-" & " " & contador
                         wsBoletos.Cells(b, "Q").Value = totalPorData
                         wsBoletos.Cells(b, "R").Value = "CONCILIADO COM EXTRATO"
                      End If
                    Next b
                    
                    Exit For 
                End If
            End If
          End If
        Next j
        contador = contador + 1
    Next dataPrevista
    
    MsgBox "Processo de conciliação concluído!"


End Sub

Sub DestrincharExtratoComRecebimento()

    Dim wsExt As Worksheet
    Set wsExt = ThisWorkbook.Worksheets("ExtratosBancarios")

    Dim wsCartao As Worksheet
    Set wsCartao = ThisWorkbook.Worksheets("CIELORECEB")
    
    Dim wsBoleto As Worksheet
    Set wsBoleto = ThisWorkbook.Worksheets("BOLETODECOB")
    
    Dim ultimaLinhaExt As Long
    ultimaLinhaExt = wsExt.Cells(wsExt.Rows.Count, "A").End(xlUp).Row

    Dim ultimaLinhaCartao As Long
    ultimaLinhaCartao = wsCartao.Cells(wsCartao.Rows.Count, "A").End(xlUp).Row
    
    Dim ultimaLinhaBoleto As Long
    ultimaLinhaBoleto = wsBoleto.Cells(wsBoleto.Rows.Count, "A").End(xlUp).Row
    
    Dim i As Long, j As Long, b As Long
    Dim conciliacaoCartao As String, conciliacaoExt As String, conciliacaoBoleto As String, statusDestrinchamento As String
    Dim valorCartao As Double, valorBoleto As Double
    Dim x As Long
    Dim z As Long
    Dim cellsDestrinchada As Variant
    
    
    x = 1000
    
    For i = 10 To ultimaLinhaExt + x

        conciliacaoExt = wsExt.Cells(i, 10).Value
        statusDestrinchamento = wsExt.Cells(i, 12).Value

        If statusDestrinchamento = "Valor Destrinchado" Or statusDestrinchamento = "MONTANTE" Then
        
        Else
        
            For j = 3 To ultimaLinhaCartao
                conciliacaoCartao = wsCartao.Cells(j, 14).Value
                valorCartao = wsCartao.Cells(j, 6).Value
                
                If Not IsEmpty(wsCartao.Cells(j, 14).Value) Then
                
                    If conciliacaoExt = conciliacaoCartao Then
                        wsExt.Rows(i + 1).Insert Shift:=xlDown, CopyOrigin:=xlFormatFromLeftOrAbove
                            
                        wsExt.Cells(i + 1, 7).Value = valorCartao
                        wsExt.Cells(i + 1, 1).Value = wsExt.Cells(i, 1).Value
                        wsExt.Cells(i + 1, 4).Value = wsExt.Cells(i, 4).Value
                        wsExt.Cells(i + 1, 5).Value = wsExt.Cells(i, 5).Value
                        wsExt.Cells(i + 1, 6).Value = wsExt.Cells(i, 6).Value
                        wsExt.Cells(i + 1, 8).Value = wsExt.Cells(i, 8).Value
                        wsExt.Cells(i + 1, 9).Value = wsExt.Cells(i, 9).Value
                        wsExt.Cells(i + 1, 10).Value = wsExt.Cells(i, 10).Value
                        wsExt.Cells(i + 1, 12).Value = "Valor Destrinchado"
                        wsExt.Cells(i + 1, 18).Value = wsCartao.Cells(j, 5).Value
                        wsExt.Cells(i + 1, 20).Value = wsExt.Cells(i, 20).Value
                        
                        If Not IsEmpty(wsCartao.Cells(j, 15).Value) Then
                        
                            wsExt.Cells(i + 1, 11).Value = "NFS-e" & " " & wsCartao.Cells(j, 15).Value & " - " & wsCartao.Cells(j, 16).Value
                            wsExt.Cells(i + 1, 19).Value = "CONCILIADO_CARTÃO"
                        Else
                        
                            wsExt.Cells(i + 1, 11).Value = wsCartao.Cells(j, 15).Value & " - " & wsCartao.Cells(j, 16).Value
                            wsExt.Cells(i + 1, 19).Value = "A CONCILIAR_CARTÃO"
                            
                        End If
            
                        wsExt.Range(wsExt.Cells(i + 1, 1), wsExt.Cells(i + 1, 12)).Interior.Color = RGB(255, 255, 0)
                        
                        If wsExt.Cells(i, 12).Interior.Color <> RGB(255, 255, 0) Then
                            wsExt.Cells(i, 12).Value = "MONTANTE"
                        End If

                        
                        i = i + 1
                        
                    End If
                
                Else
                
                End If
                
                
            Next j
            
            For b = 3 To ultimaLinhaBoleto
                conciliacaoBoleto = wsBoleto.Cells(b, 14).Value
                valorBoleto = wsBoleto.Cells(b, 12).Value
                
                If Not IsEmpty(wsBoleto.Cells(b, 14).Value) Then
                
                    If conciliacaoBoleto = conciliacaoExt Then
                        wsExt.Rows(i + 1).Insert Shift:=xlDown, CopyOrigin:=xlFormatFromLeftOrAbove
                        
                        wsExt.Cells(i + 1, 7).Value = valorBoleto
                        wsExt.Cells(i + 1, 1).Value = wsExt.Cells(i, 1).Value
                        wsExt.Cells(i + 1, 4).Value = wsExt.Cells(i, 4).Value
                        wsExt.Cells(i + 1, 5).Value = wsExt.Cells(i, 5).Value
                        wsExt.Cells(i + 1, 6).Value = wsExt.Cells(i, 6).Value
                        wsExt.Cells(i + 1, 8).Value = wsExt.Cells(i, 8).Value
                        wsExt.Cells(i + 1, 9).Value = wsExt.Cells(i, 9).Value
                        wsExt.Cells(i + 1, 10).Value = wsExt.Cells(i, 10).Value
                        wsExt.Cells(i + 1, 12).Value = "Valor Destrinchado"
                        wsExt.Cells(i + 1, 17).Value = wsBoleto.Cells(b, 8).Value
                        wsExt.Cells(i + 1, 20).Value = wsExt.Cells(i, 1).Value
                        
                        If Not IsEmpty(wsBoleto.Cells(b, 15).Value) Then
                        
                            wsExt.Cells(i + 1, 11).Value = "NFS-e" & " " & wsBoleto.Cells(b, 15).Value & " - " & wsBoleto.Cells(b, 16).Value
                            wsExt.Cells(i + 1, 19).Value = "CONCILIADO_BOLETO"
                            
                        Else
                            wsExt.Cells(i + 1, 11).Value = wsBoleto.Cells(b, 15).Value & " - " & wsBoleto.Cells(b, 16).Value
                            wsExt.Cells(i + 1, 19).Value = "A CONCILIAR_BOLETO"
                        
                        End If
                        
        
                        wsExt.Range(wsExt.Cells(i + 1, 1), wsExt.Cells(i + 1, 12)).Interior.Color = RGB(255, 255, 0)
                        
                        If wsExt.Cells(i, 12).Interior.Color <> RGB(255, 255, 0) Then
                            wsExt.Cells(i, 12).Value = "MONTANTE"
                        Else
                        End If

                        i = i + 1
                        
                    End If
                
                Else
                
                End If
            
            Next b
        
        End If
        
    
    Next i
    

End Sub

Sub Export_Mister()

ExportacaoMister.Show

End Sub
